<!--

CONVENTIONS:

* ERRORS: Add .fc-alert-container- -error to the div.form-group
* Error messages are div.alert.alert-danger

* SUCCESS: Add .has-success to the div.form-group
* Success messages are div.alert.alert-success

* Info messages are div.alert.alert-info


TODO:
* Change all .alert to labels for inputs?

-->
{% block checkout %}
{# do no remove this outer div;
   the data-fc-id="block-checkout" element
   must not be the most outer element #}
<div>
<div data-fc-id="block-checkout">
<section data-fc-error-notifier><h3 data-fc-notifier-text></h3></section>
{# BEGIN CHECKOUT TWIG TEMPLATE #}
<div class="fc-checkout fc-container">
<div id="fc-checkout-container" class="fc-checkout__main fc-checkout__row">




{% block sidebar %}
<div class="fc-sidebar fc-sidebar--checkout">

    {% block logo %}
    {% if config.store_logo_url %}
    <img id="fc-logo" src="{{ config.cache_path }}{{ config.store_logo_url }}" class="fc-logo__image" alt="{{ store_name }}">
    {% else %}
    <h1 class="fc-logotype">{{ config.store_name }}</h1>
    {% endif %}
    {% endblock logo %}

    <div data-fc-container="cart">
        {% include 'cart.inc.twig' %}
    </div>

</div><!-- .fc-sidebar.fc-sidebar--checkout -->
{% endblock sidebar %}


<div id="fc-main" class="fc-checkout__main__contents">

    {% block checkout_errors %}
        {% include 'errors.inc.twig' %}
    {% endblock checkout_errors %}

    {% block noscript_warning %}
    <noscript>
        <div id="fc-noscript-errors" class="fc-alert fc-alert--danger">
            <h2>{{ config.lang.checkout_warning }}</h2>
            <p>{{ config.lang.checkout_no_javascript_message|raw }}</p>
        </div><!-- #fc-noscript-errors -->
    </noscript>
    {% endblock noscript_warning %}


    <form method="post" class="fc-checkout__main__form" data-fc-id="checkout-form" action="https://{{ config.store_domain }}{{ config.post_url }}">
        {# A trap to catch webkit's overagressive autofill. #}
        <div style="position: absolute; top: -100px; opacity: 0;"><input type="text" name="email_dummy" data-fc-dummy tabindex="-1"/><input type="password" name="password_dummy" data-fc-dummy tabindex="-1"/></div>

        <div data-fc-id="required-hidden-fields">
        {% block required_hidden_fields %}
            <input type="hidden" id="ThisAction" name="ThisAction" value="checkout" />
            <input type="hidden" id="customer_id" name="customer_id" value="{{ customer_id_encoded }}" />
            <input type="hidden" id="{{ session_name }}" name="{{ session_name }}" value="{{ session_id }}" />
            <input type="hidden" id="is_anonymous" name="is_anonymous" value="{{ is_anonymous ? 1 : 0 }}" />
            <input type="hidden" id="anonymous_checkout_selected" name="anonymous_checkout_selected" value="{{ anonymous_checkout_selected ? 1 : 0 }}" />
            <input type="hidden" id="email_is_found" name="email_is_found" value="{{ email_is_found ? 1 : 0 }}" />

            {% if auth_token_is_valid %}
                <input type="hidden" id="fc_auth_token" name="fc_auth_token" value="{{ fc_auth_token }}" />
                <input type="hidden" id="timestamp" name="timestamp" value="{{ timestamp }}" />
                <input type="hidden" id="fc_customer_id" name="fc_customer_id" value="{{ fc_customer_id }}" />
            {% endif %}

            {# preserve paypal express variables #}
            {% if token != '' and payer_id != '' %}
                <input type="hidden" id="token" name="token" value="{{ token }}" />
                <input type="hidden" id="PayerID" name="PayerID" value="{{ payer_id }}" />
            {% endif %}
            {% for var_name, var_value in hosted_gateway_vars %}
                <input type="hidden" id="{{ var_name }}" name="{{ var_name }}" value="{{ var_value }}" />
            {% endfor %}
        {% endblock required_hidden_fields %}
        </div><!-- data-fc-id="required-hidden-fields" -->



<div data-fc-id="block-login-register" id="fc-checkout__section--email">
{% block login_register %}
    <fieldset id="fc-email">
        <legend><span class="fc-section-counter"></span> {{ config.lang.checkout_email }}</legend>

        {# logic for setting the wrapper class regarding alerts, if one is needed #}
        {% if email_is_checking %}
            {% set message_class = 'fc-alert-container--info' %}
        {% elseif email_is_valid and email_is_found %}
            {% set message_class = 'fc-alert-container--success' %}
        {% elseif not email_is_valid %}
            {% set message_class = 'fc-alert-container--error' %}
        {% else %}
            {% set message_class = '' %}
        {% endif %}

        {% set error_string = utils.get_error_string('customer_email', messages.errors) %}
        <div class="fc-form-group {{ message_class }}">
            <div class="fc-container__grid--input--customer-email{% if error_string %} fc-alert-container--error{% endif %}" data-fc-error-for="customer_email" data-fc-error-class="fc-alert-container--error">
        {% if not customer_is_authenticated %}
            {# Not SSO authenticated #}
            <label for="customer_email" class="fc-form-label--customer-email">{{ config.lang.email_email }}</label>
            <input type="email"
                id="customer_email"
                name="customer_email"
                value="{{ customer_email }}"
                placeholder="{{ config.lang.email_email }}"
                autocomplete="off"
                class="fc-form-control"
                {% if is_subscription_cancel %}
                disabled
                {% endif %}
                formnovalidate
                autofocus />
            {% if email_is_valid %}
                {% if is_anonymous == 1 or (has_subscriptions == false and checkout_type == 'guest_only') %}
                {# guest checkout: do nothing #}
                {% else %}
                    {% if email_is_checking %}
                        <div class="fc-alert fc-alert--info">
                            <p>{{ config.lang.checkout_instructions_email_checking }}</p>
                            <div class="fc-spinner">
                              <div class="bounce1"></div>
                              <div class="bounce2"></div>
                              <div class="bounce3"></div>
                            </div>
                        </div>

                    {% elseif email_is_found %}
                        <div class="fc-alert fc-alert--success{% if authentication_is_not_successful %} fc-alert-container--error{% endif %}" data-fc-error-for="customer_password" data-fc-error-class="fc-alert-container--error" data-fc-messaging-for="customer_email">
                            <p>{{ config.lang.checkout_as_returning_customer }}</p>
                            <div class="fc-input-group">
                                <label for="customer_password" class="fc-form-label--customer-password">{{ config.lang.checkout_password }}</label>
                                <input type="password"
                                    id="customer_password"
                                    name="customer_password"
                                    value="{{ customer_password }}"
                                    placeholder="{{ config.lang.checkout_password }}"
                                    autocomplete="current-password"
                                    class="fc-form-control fc-form-control--customer-password" />
                                <span class="fc-input-group__button">
                                    <button class="fc-button fc-button--sign-in" data-fc-id="sign-in" type="button">{{ config.lang.checkout_sign_in }}</button>
                                </span>
                            </div>
                            {% if authentication_is_in_progress %}
                            <div class="fc-alert fc-alert--info">
                                <p>{{ config.lang.checkout_loading }}
                                    <div class="fc-spinner">
                                      <div class="bounce1"></div>
                                      <div class="bounce2"></div>
                                      <div class="bounce3"></div>
                                    </div>
                                </p>
                            </div>

                            {% endif %}
                            {% if authentication_is_successful %}
                            <div class="fc-alert fc-alert--success">
                                {% if force_password_reset %}
                                <p>{{ config.lang.checkout_found_customer_force_password_reset }}</p>
                                {% else %}
                                <p>{{ config.lang.checkout_found_customer_info_logged_in }}</p>
                                {% endif %}
                            </div>
                            {% elseif authentication_is_not_successful %}
                            <div class="fc-alert fc-alert--danger">
                                <p>{{ config.lang.checkout_error_incorrect_password }}</p>
                            </div>
                            {% endif %}
                            {% if temporary_password_sent %}
                            <div class="fc-alert fc-alert--info">
                                <p>{{ config.lang.checkout_password_sent_to }} {{ customer_email }}{{ config.lang.checkout_password_sent_check_spam }}</p>
                            </div>
                            {% endif %}
                            {% if password_expired %}
                            <div class="fc-alert fc-alert--danger">
                                <p>{{ config.lang.checkout_error_password_expired }}</p>
                            </div>
                            {% endif %}
                            {% if change_password %}
                            <div class="fc-alert fc-alert--success">
                                <p>{{ config.lang.checkout_change_password_instructions }}</p>
                            </div>
                            {% endif %}

                            <ul class="fc-password-actions fc-list--inline">
                            {% if authentication_is_successful %}
                                {% if change_password == false %}
                                <li class="fc-password-action--change fc-password-action">
                                    <small class="fc-password-action--button-container"><button data-fc-id="change-password" type="button" class="fc-button-link">{{ config.lang.checkout_change_my_password }}</button></small>
                                </li>
                                {% endif %}
                            {% else %}
                                {% if change_password == false and temporary_password_sent == false %}
                                <li class="fc-password-action--reset fc-password-action">
                                    <small class="fc-password-action--button-container"><button data-fc-id="reset-password" type="button" class="fc-button-link">{{ config.lang.checkout_email_my_password }}</button></small>
                                </li>
                                {% endif %}
                                {% if is_updateinfo == false and has_subscriptions == false and checkout_type != 'account_only' %}
                                <li class="fc-password-action--guest fc-password-action">
                                    <small class="fc-password-action--button-container"><button data-fc-id="checkout-as-guest" type="button" class="fc-button-link">{{ config.lang.checkout_as_guest|raw }}</button></small>
                                </li>
                                {% endif %}
                            {% endif %}
                            </ul>
                        </div>
                    {% elseif is_updateinfo %}
                        {% set error_string = utils.get_error_string('updateinfo',messages.errors) %}
                        {% if error_string %}
                        <div class="fc-alert fc-alert--danger">
                            <p>{{ config.lang.checkout_updateinfo_email_not_found }}</p>
                        </div>
                        {% endif %}
                    {% endif %}
                    {# email not found, do nothing #}
                {% endif %}
            {% else %}
                <div class="fc-alert fc-alert--danger">
                {{ config.lang.checkout_error_email }}
                </div>
            {% endif %}
        {% else %}{# customer_is_authenticated #}
            {# Is SSO authenticated, email is readonly #}
            {{ customer_email }}
            {# Why do we need a hidden email field below?
            If we use it for setting the email, it's unsafe. #}
            <input type="hidden" name="customer_email" id="customer_email" value="{{ customer_email }}" />
            {{ config.lang.checkout_sso_already_logged_in }}
        {% endif %}

            </div>
        </div>
    </fieldset>
{% endblock login_register %}
</div><!-- data-fc-id="block-login-register" -->


{% if not is_subscription_cancel %}

    {# SHIPPING ADDRESS ===================================================== #}
    {% if has_shippable_products %}
        <div data-fc-id="block-customer-shipping" class="fc-checkout__section--customer-shipping-address">
        {% block customer_shipping %}
            {% if not has_multiship %}
                {% include "address.checkout.inc.twig" with {'address': shipping_address} %}
                {{ utils.use_different_addresses(use_different_addresses, config.lang) }}
            {% else %}
                {% for multiship in multiship_data %}
                    {% include 'address.checkout.inc.twig' with {'address': multiship} %}
                    {% if MULTISHIP_PREVIOUSLY_USED_SHIPTOS_EXIST %}
                        {# previously used addresses select box #}
                    {% endif %}
                    {# Subtotal (shipto subtotal + shipping + tax) #}
                {% endfor %}
            {% endif %}
        {% endblock customer_shipping %}
        </div><!-- data-fc-id="block-customer-shipping" -->
    {% endif %}

    {# BILLING ADDRESS ===================================================== #}
    <div data-fc-id="block-customer-billing" class="fc-checkout__section--customer-billing-address">
    {% block customer_billing %}
        {% if use_alternate_shipping_address or not has_shippable_products or has_multiship %}
            {% include "address.checkout.inc.twig" with {'address': billing_address} %}
        {% endif %}
    {% endblock customer_billing %}
    </div><!-- data-fc-id="block-customer-billing" -->

    {# SHIPPING METHOD ===================================================== #}
    {% if has_live_rate_shippable_products %}
        {% if not has_multiship %}
        <div data-fc-id="block-shipping-results" class="fc-checkout__section--shipping-results">
            <fieldset data-fc-id="shipping-results">
                <legend><span class="fc-section-counter"></span> {{ config.lang.checkout_shipping_method }}</legend>

                {% if loading_shipping_results %}
                    <div class="fc-spinner">
                      <div class="bounce1"></div>
                      <div class="bounce2"></div>
                      <div class="bounce3"></div>
                    </div>
                {% endif %}

                {% if shipping_address.shipping_results|length > 0 %}
                    {{ utils.shipping_results(shipping_address, "fc-input-group--full-page", messages.errors, config.lang) }}
                {% endif %}

                {% set error_string = utils.get_error_string('shipping-results',messages.errors) %}

                {% if error_string %}
                <div class="fc-alert fc-alert--danger">
                    {{ error_string }}
                </div>
                {% endif %}
            </fieldset>
        </div><!-- data-fc-id="block-shipping-results" -->
        {% endif %}
    {% endif %}



    {# PAYMENT METHOD ===================================================== #}
    <div data-fc-id="block-payment-method" class="fc-checkout__section--payment">
    {% block payment_method %}
        {% set payment_method_input_type = config.has_multiple_payment_options or has_saved_cc ? 'radio' : 'hidden' %}
        <fieldset id="fc-payment" data-fc-container="payment">
            <legend><span class="fc-section-counter"></span> {{ config.lang.checkout_payment_method }}</legend>

            {% if payment_info_required %}
            <svg id="fc-icon-lock-large" class="fc-svg-icon hidden-xs hidden-sm"><use xlink:href="#fa-lock-large" /></svg>
            {% endif %}

            {% if config.supports_pay_with_plastic and payment_info_required %}

                {% if has_saved_cc %}

                {% set error_string = utils.get_error_string('cc_cvv2_saved',messages.errors) %}
            <div class="fc-form-group {% if error_string %}fc-alert-container--error{% endif %}" data-fc-id="payment-method-plastic-saved-group" data-fc-error-for="cc_cvv2_saved" data-fc-error-class="fc-alert-container--error">
                <div id="fc-payment-method-plastic-saved" class="fc-container__grid--payment-method fc-payment-method--plastic__saved">
                    <div class="fc-input-group-container fc-input-group-container--radio {% if payment_method_type == "plastic_saved" %}fc-input-group-container--active{% endif %}">
                        <label for="fc_payment_method_plastic_saved" class="fc-input-group-container__title fc-form-label--plastic-saved fc-form-label">
                            <input type="hidden" name="cc_type" id="cc_type" value="{{ cc_type }}" />
                            <input type="radio"
                                {{ checked(payment_method_type, 'plastic_saved') }}
                                id="fc_payment_method_plastic_saved"
                                name="fc_payment_method"
                                value="plastic_saved"
                                autocomplete="off"
                                class="fc-form-control--plastic-saved--checkbox fc-form-control"/>
                            {% if cc_type %}
                                <span class="fc-checkout__section--payment__method__logo"><img data-fc-id="card_type_img" src="//cdn.foxycart.com/static/images/payment_logos/sets/smashing/{{ cc_type|lower }}.png" alt="{{ cc_type }}" /></span>
                            {% else %}
                                <span class="fc-checkout__section--payment__method__logo"><img data-fc-id="card_type_img" src="//cdn.foxycart.com/static/images/payment_logos/sets/smashing/visa.png" alt="visa" /></span>
                            {% endif %}
                            {{ config.lang.checkout_use_saved_payment_info }}
                            <span class="fc-payment-method-plastic-saved  fc-payment-method--plastic-saved__card-number " data-fc-id="masked-card">{{ cc_number_masked }}</span>
                            <input type="hidden" name="cc_number_masked" id="cc_number_masked" value="{{ cc_number_masked }}" />
                            <input type="hidden" name="cc_exp_year_saved" id="cc_exp_year_saved" value="{{ cc_exp_year }}" />
                            <input type="hidden" name="cc_exp_month_saved" id="cc_exp_month_saved" value="{{ cc_exp_month }}" />
                        </label>

                        <svg class="fc-svg-icon visible-xs visible-sm"><use xlink:href="#fa-lock" /></svg>

                        {% if payment_method_type == "plastic_saved" %}
                            <div class="fc-form-group">
                                <label for="" class="fc-form-label__plastic-saved-expiration fc-form-label">{{ config.lang.checkout_expiration }}</label>
                                <div class="fc-container__static--plastic-saved-expiration ">
                                    <p class="fc-form-control--static">{{ cc_exp_month }} {{ cc_exp_year }}</p>
                                </div>
                            </div>
                            {% if is_updateinfo == false and ((config.template_config.csc_requirements == "all_cards" and is_uoe == false) or (config.template_config.csc_requirements == "sso_only" and customer_is_authenticated)) %}
                            <div class="fc-form-group">
                                <label class="fc-form-label fc-form-label--cvv2-saved " for="cc_cvv2_saved">{{ config.lang.checkout_card_verification_code }}</label>
                                <div class="fc-container__grid--static--plastic-saved-csc">
                                    <input type="tel"
                                        id="cc_cvv2_saved"
                                        name="cc_cvv2_saved"
                                        value="{{ cc_cvv2_saved }}"
                                        maxlength="4"
                                        placeholder="{{ config.lang.checkout_csc }}"
                                        autocomplete="off"
                                        class="fc-form-control fc-form-control--cvv2-saved" />
                                </div>
                            </div>
                            {% endif %}
                        {% endif %}

                        <div class="fc-alert fc-alert--danger {{ error_string ? 'show' : 'hidden' }}" data-fc-error-for="cc_cvv2_saved" data-fc-error-class="show,hidden">
                            {{ config.lang.checkout_error_verification_code }}
                        </div>
                    </div>
                </div>
            </div>
                {% endif %}{# has_saved_cc #}

                {% set cvv2_error_string = utils.get_error_string('cc_cvv2',messages.errors) %}
                {% set cc_number_error_string = utils.get_error_string('cc_number',messages.errors) %}

            <div class="fc-form-group" data-fc-id="fc-payment-method-plastic-new" data-fc-error-for="cc_number cc_exp_month cc_exp_year cc_cvv2" data-fc-error-class="fc-alert-container--error">
                <div id="fc-payment-method-plastic-new" class="fc-container__grid--payment-method fc-payment-method--plastic__new">
                    <div class="fc-input-group-container {% if payment_method_input_type == 'radio' or has_saved_cc %}fc-input-group-container--radio{% endif %} {% if payment_method_type == 'plastic_new' %}fc-input-group-container--active{% endif %}">
                        <label for="fc_payment_method_plastic_new" class="fc-form-label--plastic-new {% if payment_method_input_type != 'radio' %}fc-input-group-container__title fc-input-group-container__title--forced{% else %} fc-input-group-container__title{% endif %}">
                            <!-- TODO: need to set the fc_payment_method=plastic for this -->
                            <!-- TODO: What's the payment_method_type doing in this context? Used for hard errors? -->
                            <input type="{{ payment_method_input_type }}"
                                {{ checked(payment_method_type, 'plastic_new') }}
                                id="fc_payment_method_plastic_new"
                                name="fc_payment_method"
                                value="plastic_new"
                                autocomplete="cc-number"
                                class="fc-form-control--plastic-new--checkbox fc-form-control" />
                        {% for card_type in config.template_config.supported_payment_cards %}
                            <span class="fc-checkout__section--payment__method__logo
                            fc-checkout__section--payment__method__logo-{{ card_type }}">
                                <img class="fc-checkout__section--payment__method__logo--{{ card_type }}" src="//cdn.foxycart.com/static/images/payment_logos/sets/smashing/{{ card_type }}.png" alt="{{ card_type }}" />
                            </span>
                        {% endfor %}
                        {% if has_saved_cc %}
                        {# Show the text only when there's a saved card #}
                        {{ config.lang.checkout_enter_new_card }}
                        {% endif %}
                        </label>
                        {% if payment_method_type == 'plastic_new' %}
                        <div class="fc-form-group fc-form-group-multiple-inline {% if cc_number_error_string %}fc-alert-container--error{% endif %}" data-fc-error-for="cc_number" data-fc-error-class="fc-alert-container--error,fc-alert-container--success">
                            <label class="fc-form-label fc-form-label--new-cc-number" for="cc_number">{{ config.lang.checkout_card_number }}</label>
                            <div class="fc-container__grid--input--plastic-new-card-number">
                                <input type="tel"
                                    id="cc_number"
                                    name="cc_number"
                                    value="{{ cc_number }}"
                                    maxlength="16"
                                    placeholder="{{ config.lang.checkout_card_number }}"
                                    autocomplete="cc-number"
                                    class="fc-form-control fc-form-control--new-cc-number" />
                                <svg class="fc-svg-icon fc-cc-icon visible-xs visible-sm"><use xlink:href="#fa-lock" /></svg>
                            </div>
                        </div>
                        <div class="fc-form-group fc-form-group-multiple-inline">
                            <label class="fc-form-label--new-cc-exp-month fc-form-control--static fc-form-label" for="cc_exp_month">{{ config.lang.checkout_expiration }}</label>
                            <label class="fc-form-label fc-form-label--new-cc-exp-year" for="cc_exp_year">{{ config.lang.cart_year|raw }}</label>
                            <label class=" fc-form-label fc-form-label--new-cc-cvv2" for="cc_cvv2">{{ config.lang.checkout_cart_verification_code }}</label>
                            {% set field_name = 'cc_exp_month' %}
                            {% set error_string = utils.get_error_string(field_name, messages.errors) %}
                            <div id="fc-payment-method-plastic-expires-month" class="fc-container__grid--plastic-new-exp-month {% if error_string %}fc-alert-container--error{%endif %}" data-fc-error-for="{{ field_name }}" data-fc-error-class="fc-alert-container--error,has-success">
                                <select class="fc-form-control--new-cc-exp-month fc-form-control" name="cc_exp_month" id="cc_exp_month" autocomplete="cc-exp-month" >
                                    <option value="">{{ config.lang.cart_month }}</option>
                                    {% for month in config.cc_expiration_months %}
                                    <option value="{{ month.value }}" {{ selected(cc_exp_month, month.value) }}>
                                        {{ month.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% set field_name = 'cc_exp_year' %}
                            {% set error_string = utils.get_error_string(field_name, messages.errors) %}
                            <div id="fc-payment-method-plastic-expires-year" class="fc-container__grid--plastic-new-exp-year {% if error_string %}fc-alert-container--error{%endif %}" data-fc-error-for="{{ field_name }}" data-fc-error-class="fc-alert-container--error,has-success">
                                <select class="fc-form-control--new-cc-exp-year fc-form-control" name="cc_exp_year" id="cc_exp_year" autocomplete="cc-exp-year" >
                                    <option value="">{{ config.lang.cart_year }}</option>
                                    {% for year in config.cc_expiration_years %}
                                    <option value="{{ year }}" {{ selected(cc_exp_year, year) }}>
                                        {{ year }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            {% set field_name = 'cc_cvv2' %}
                            {% set error_string = utils.get_error_string(field_name, messages.errors) %}
                            <div id="fc-payment-method-plastic-csc" class="fc-container__grid--plastic-new-csc {% if error_string %}fc-alert-container--error{%endif %}" data-fc-error-for="cc_cvv2" data-fc-error-class="fc-alert-container--error,has-success">
                                <input type="tel"
                                    id="cc_cvv2"
                                    name="cc_cvv2"
                                    value="{{ cc_cvv2 }}"
                                    maxlength="4"
                                    placeholder="{{ config.lang.checkout_csc }}"
                                    autocomplete="cc-csc"
                                    class="fc-form-control fc-form-control--new-cc-cvv2"
                                     />
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="fc-alert fc-alert--danger {{ cvv2_error_string ? 'show' : 'hidden' }}" data-fc-error-for="cc_cvv2" data-fc-error-class="show,hidden">
                        {{ config.lang.checkout_error_verification_code }}
                    </div>
                    <div class="fc-alert fc-alert--danger {{ cc_number_error_string ? 'show' : 'hidden' }}" data-fc-error-for="cc_number" data-fc-error-class="show,hidden">
                        {{ config.lang.checkout_error_card_number }}
                    </div>
                </div>
            </div>
            {% endif %}{# config.supports_pay_with_plastic and payment_info_required #}

            {% if payment_info_required and show_paypal_express_payment_option and not is_updateinfo %}
            <div class="fc-form-group">
                <div id="fc-payment-method-paypal" class="fc-container__grid--payment-method fc-payment-method--paypal">
                    <div class="fc-input-group-container {% if payment_method_input_type == 'radio' or has_saved_cc %}fc-input-group-container--radio{% endif %} {% if payment_method_type == 'paypal' %}fc-input-group-container--active{% endif %}">
                        <label class="fc-input-group-container__title {% if payment_method_input_type == 'hidden' %}fc-input-group-container__title--forced{% endif %}">
                            <input type="{{ payment_method_input_type }}"
                                {{ checked(payment_method_type, 'paypal') }}
                                id="fc_payment_method_paypal"
                                name="fc_payment_method"
                                value="paypal"
                                autocomplete="off"
                                class="fc-form-control fc-form-control--paypal" />
                            {{ config.lang.checkout_pay_with_paypal|raw }}
                        </label>
                        {% if payment_method_type == 'paypal' %}
                        <div class="fc-form-group fc-form-group-multiple-inline">
                            {{ config.lang.checkout_payment_method_paypal }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}{# show_paypal_express_payment_option and not is_updateinfo #}

            {% if not is_updateinfo and payment_info_required %}
                {% for hosted_gateway in hosted_payment_gateways if ((hosted_gateway.supports_subscriptions == false and has_subscriptions == false) or hosted_gateway.supports_subscriptions) %}
            <div class="fc-form-group">
                <div id="fc-payment-method-{{ hosted_gateway.type }}" class="fc-container__grid--payment-method fc-payment-method--{{ hosted_gateway.type }}">
                    <div class="fc-input-group-container {% if payment_method_input_type == 'radio' or has_saved_cc %}fc-input-group-container--radio{% endif %} {% if payment_method_type == hosted_gateway.type %}fc-input-group-container--active{% endif %}">
                        <label class="fc-input-group-container__title {% if payment_method_input_type == 'hidden' %}fc-input-group-container__title--forced{% endif %}">
                            <input type="{{ payment_method_input_type }}"
                                {{ checked(payment_method_type, hosted_gateway.type) }}
                                id="fc_payment_method_{{ hosted_gateway.type }}"
                                name="fc_payment_method"
                                value="{{ hosted_gateway.type }}"
                                autocomplete="off"
                                class="fc-form-control fc-form-control--{{ hosted_gateway.type }}" />
                            {{ hosted_gateway.lang_pay_with|raw }}
                        </label>
                        {% if payment_method_type == hosted_gateway.type %}
                        <div class="fc-form-group fc-form-group-multiple-inline">
                            {{ hosted_gateway.lang_payment_method }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
                {% endfor %}
            {% endif %}{# not is_updateinfo and payment_info_required #}

            {% if config.supports_purchase_order and not is_updateinfo %}
            <div class="fc-form-group" data-fc-error-for="purchase_order" data-fc-error-class="fc-alert-container--error">
                <div id="fc-payment-method-purchase-order" class="fc-container__grid--payment-method fc-payment-method--purchase-order">
                    {% set po_error_string = utils.get_error_string('purchase_order', messages.errors) %}
                    <div class="fc-input-group-container {% if payment_method_input_type == 'radio' %}fc-input-group-container--radio{% endif %} {% if payment_method_type == 'purchase_order' %}fc-input-group-container--active{% endif %}">
                        <label class="fc-input-group-container__title {% if payment_method_input_type == 'hidden' %}fc-input-group-container__title--forced{% endif %}">
                            <input type="{{ payment_method_input_type }}"
                                {{ checked(payment_method_type, 'purchase_order') }}
                                id="fc_payment_method_purchase_order"
                                name="fc_payment_method"
                                value="purchase_order"
                                autocomplete="off"
                                class="fc-form-control fc-form-control--po"/>
                            {{ config.lang.checkout_pay_with_purchase_order }}
                        </label>
                        {% if payment_method_type == 'purchase_order' %}
                        <div class="fc-form-group">
                            <label class="fc-container__grid--label--po fc-form-label" for="purchase_order">{{ config.lang.checkout_purchase_order_number }}</label>
                            <div class="fc-container__grid--input--po">
                                <input type="text"
                                    id="purchase_order"
                                    name="purchase_order"
                                    value="{{ purchase_order }}"
                                    maxlength="30"
                                    placeholder=""
                                    autocomplete="off"
                                    data-fc-required
                                    class="fc-form-control fc-form-control--po"/>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="fc-alert fc-alert--danger {{ po_error_string ? 'show' : 'hidden' }}" data-fc-error-for="purchase_order" data-fc-error-class="show,hidden">
                        <div class="">{{ config.lang.checkout_error_purchase_order }}</div>
                    </div>
                </div>
            </div>
            {% endif %}{# config.supports_purchase_order and not is_updateinfo #}

            {% if not payment_info_required %}
            <div class="fc-form-group">
                <div id="fc-payment-method-no-payment-needed" class="fc-container__grid--payment-method fc-payment-method--no-payment fc-payment-method col-md-8 col-md-offset-3">
                {{ config.lang.checkout_no_payment_needed }}
                </div>
            </div>
            {% endif %}{# payment_info_required #}

        </fieldset>
    {% endblock payment_method %}
    </div><!-- data-fc-id="block-payment-method" -->


    {# ADDITIONAL FIELDS ===================================================== #}
    <div data-fc-id="block-additional-fields">
    {% block additional_fields %}
        <fieldset id="fc-additional-fields">
            <legend><span class="fc-section-counter"></span> {{ config.lang.checkout_almost_done }}</legend>

            {% if config.template_config.custom_script_values.checkout_fields %}
                {% include template_from_string(config.template_config.custom_script_values.checkout_fields) %}
            {% endif %}

            {% if config.template_config.tos_checkbox_settings.usage != "none" %}
            {# ToDo: Needs to take into account if the field is required or optional #}
            <div class="fc-form-group">
                {% set field_name = 'tos_agreement' %}
                {% set error_string = utils.get_error_string(field_name, messages.errors) %}
                <div class="fc-checkout__additional-field--tos {% if error_string %}fc-alert-container--error{%endif %}" data-fc-error-for="{{ field_name }}" data-fc-error-class="fc-alert-container--error">
                    <div class="fc-input-group-container fc-input-group-container--checkbox">
                        <label class="fc-input-group-container__title fc-form-label fc-form-label--tos">
                            <input type="checkbox"
                                id="tos_agreement"
                                name="tos_agreement"
                                value="true"
                                class="fc-form-control fc-form-control--tos"
                                {{ checked(tos_agreement == "true") }} />
                            {{ config.lang.checkout_tos|replace({
                                '{{url}}': config.template_config.tos_checkbox_settings.url
                            })|raw }}
                        </label>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if config.template_config.newsletter_subscribe.usage != "none" %}
            <div class="fc-form-group">
                <div class="fc-checkout__additional-field--subscribe">
                    <div class="fc-input-group-container fc-input-group-container--checkbox">
                        <label class="fc-input-group-container__title fc-form-label fc-form-label--subscribe">
                            <input type="checkbox"
                                name="newsletter_subscribe"
                                value="1"
                                class="fc-form-control fc-form-control--subscribe" />
                            {{ config.lang.checkout_newsletter_subscribe }}
                        </label>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if (anonymous_checkout_selected == false) and (change_password or force_password_reset or ((is_updateinfo == false) and (email_is_found == false) and (has_subscriptions or (checkout_type != "guest_only")))) %}
            {% set error_string = utils.get_error_string('new_customer_password',messages.errors) %}
            <div class="fc-form-group" data-fc-container="account-creation" data-fc-error-for="new_customer_password" data-fc-error-class="fc-alert-container--error">
                <div class="fc-checkout__additional-field--save-account">
                    <div class="fc-input-group-container fc-input-group-container--checkbox {% if has_subscriptions or checkout_type == 'account_only' or create_account or force_password_reset or change_password %}fc-input-group-container--active{% endif %}">
                        {% if checkout_type == 'account_only' or change_password or force_password_reset %}

                        <label data-fc-id="account-creation-label" class="fc-input-group-container__title fc-form-label  fc-input-group-container__title--forced">
                            {{ config.lang.checkout_create_an_account }}
                        </label>

                        {% elseif has_subscriptions == false %}

                        <label data-fc-id="account-creation-label" class="fc-input-group-container__title fc-form-label">
                            <input
                                type="checkbox"
                                name="create_account"
                                id="create_account"
                                value="1"
                                class="fc-form-control fc-form-control--create-account"
                                {% if create_account %}checked{% endif %}
                                />
                            {{ config.lang.checkout_create_an_account }}
                        </label>

                        {% endif %}

                        {% if has_subscriptions or create_account or change_password or force_password_reset or checkout_type == 'account_only' %}
                        <div class="fc-form-group">
                            <p>{{ config.lang.checkout_no_account_enter_password }}</p>
                            {% if force_password_reset %}
                                {# put some text here...? #}
                            {% endif %}
                            <input type="password"
                                id="new_customer_password"
                                name="new_customer_password"
                                minlength="8"
                                placeholder="{{ config.lang.checkout_password }}"
                                autocomplete="new-password"
                                class="fc-form-control fc-form-control--new-customer-password"
                                data-fc-required
                                value="{{ new_customer_password }}"
                                />
                        </div>
                        {% endif %}
                    </div>
                    <div class="fc-alert fc-alert--danger {{ error_string ? 'show' : 'hidden' }}" data-fc-error-for="new_customer_password" data-fc-error-class="show,hidden">
                        <div class="">{{ config.lang.checkout_error_password }}</div>
                    </div>
                </div>
            </div>
            {% endif %}
        </fieldset>
    {% endblock additional_fields %}
    </div><!-- data-fc-id="block-additional-fields" -->

    {# SUBMIT BUTTON ===================================================== #}
    <div data-fc-id="block-submit-button" class="fc-checkout__section--submit">
    {% block submit_button %}
        <div class="fc-form-group">
            {# TODO: The context here needs to work serverside on pageload too. #}
            {% if payment_method_type in ["plastic_new", "plastic_saved"] %}
                {% if config.template_config.use_checkout_confirmation_window.usage == "required" %}
                    {% set checkout_button_text = config.lang.checkout_complete_your_purchase %}
                    {% set checkout_button_helper_text = config.lang.checkout_payment_confirmation %}
                {% else %}
                    {% set checkout_button_text = config.lang.checkout_confirm_your_purchase %}
                    {% set checkout_button_helper_text = '' %}
                {% endif %}
            {% else %}
                {% set checkout_button_helper_text = config.lang['checkout_payment_method_' ~ payment_method_type] %}
                {% set checkout_button_text = config.lang.checkout_complete_your_purchase %}
            {% endif %}
            {% if is_updateinfo %}
                {% set checkout_button_text = config.lang.checkout_update_my_information %}
                {% set checkout_button_helper_text = '' %}
            {% endif %}
            {% if is_subscription_modification %}
                {% set checkout_button_text = config.lang.checkout_update_my_subscription %}
                {% set checkout_button_helper_text = '' %}
            {% endif %}
            <div class="fc-container__grid--checkout-submit">
                <button class="fc-button fc-button--submit" data-fc-id="submit-button">{{ checkout_button_text }}</button>
            </div>
            {% if checkout_button_helper_text %}
            <div class="fc-container__grid--checkout-submit-helper-text">
                <p class="fc-container__checkout-helper-text">
                    <small>{{ checkout_button_helper_text }}</small>
                </p>
            </div>
            {% endif %}
        </div>
        {% if loading_submit %}
        <div class="fc-spinner">
          <div class="bounce1"></div>
          <div class="bounce2"></div>
          <div class="bounce3"></div>
        </div>
        {% endif %}
    {% endblock submit_button %}
    </div><!-- data-fc-id="block-submit-button" -->


{% else %}{# is_subscription_cancel #}

    <div data-fc-id="block-subscription-cancel">
    {% block subscription_cancel %}
        <fieldset id="fc-subscription-cancel">
            <legend><span class="fc-section-counter"></span> {{ config.lang.checkout_almost_done }}</legend>

            <div id="fc-submit" class="fc-form-group">
                <div class="fc-container__grid--checkout-subscription-cancel">
                    <button class="fc-button fc-button--subscription-cancel" data-fc-id="submit-button">{{ config.lang.checkout_cancel_my_subscription }}</button>
                </div>
                {# TODO: Dynamically change this text based on the authentication state? #}
                <div class="fc-container__grid--checkout-subscription-cancel-helper-text">
                    <p class="fc-container__subscription-cancel-helper-text">
                        <small>{{ config.lang.checkout_subscription_cancel_helper_text }}</small>
                    </p>
                </div>
            </div>
        </fieldset>
    {% endblock subscription_cancel %}
    </div><!-- data-fc-id="block-subscription-cancel" -->

{% endif %}



    </form>
    </div>{# #fc-main #}

</div>{# #fc-checkout__main #}
</div>{# .fc-container #}
{# END CHECKOUT TWIG TEMPLATE #}
</div><!-- data-fc-id="checkout" -->
</div>
{% endblock checkout %}
